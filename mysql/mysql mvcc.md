## MVCC 多版本并发控制

#### 幻读

在一次事务中，多次查询，结果集的个数不一致的情况叫幻读，而多一行或者少一行的行叫幻行。



#### 多版本并发控制 MVCC

目的提高数据库高并发场景下的吞吐功能。

多数数据库都实现了多版本并发控制，并且都是依靠保存数据快照实现的。以 InnoDB 为例，每一行都冗余了两个字段，一个是行的创建版本，一个是行的删除（过期）版本。

普通的 select 就是快照读。



每一行都有两个隐藏列：**DATA_TRA_ID**、**DATA_ROLL_PTR**，如果没有主键还会多一个**隐藏的主键列**。

- DATA_TRX_ID：记录最近更新这条记录的事务ID，大小为 16 字节。
- DATA_ROLL_PTR：表示指向改行回滚段（rollback segment）的指针，大小为7个字节，InnoDB 就是通过这个指针找到之前版本的数据，该行记录所有旧版本，在 undo log 中都通过链表的形式组织。
- DB_ROW_ID：行标识（隐藏单调自增ID），大小为6个字节，如果没有主键，InnoDB 会自动生成一个隐藏主键，因此会生成这个列。



##### 事务操作过程

1. 对 DB_ROW_ID = 1 这行加排他锁。
2. 把改行原本你的值拷贝到 undo log 中，DB_TRX_ID 和 DB_POLL_PTR 都不动。
3. 修改该行的值时产生了一个新的版本，更新 DB_TRX_ID，为修改记录的事务ID，将 DB_POLL_PTR 指向刚刚拷贝到 undo log 链中的旧版本记录，这样就能通过 DB_POLL_PTR 找到这条记录的历史版本。如果对同一行记录执行连续的update，undo log 会组成一个链表，便利这个链表可以看到这条记录的变迁。
4. 记录 redo log，包括 undo log 中的修改。



#### undo log 用途

- 在表信息修改之前会先把数据拷贝到 undo log 里面。当事务进行回滚的时候，可以通过 undo log 里的日志进行数据还原。
- 保证事务进行 roll back 时的原子性和一致性，当事务进行回滚的时候可以用 undo log 的数据进行恢复。



#### 如何实现一致性读：ReadView（读快照）

- 事务进行快照读操作的时候产生的读视图，在该事务执行的快照读的那一库，会生成数据库系统当前的一个快照。
- 记录并维护系统当前 活跃事务的ID（没有 commit，当每个事务开启时，都会被分配一个ID，递增的，越新的事务，ID 越大），是系统中当前不应该被本事务看到的其他事务id列表。



#### Read View 几个属性

- trx_ids：当前系统活跃（未提交）事务版本号集合。
- low_limit_id：创建当前 Read view 时，“系统正处于活跃事务最小版本号”。
- up_limit_id：创建昂前 Read view 时，“当前系统最大事务版本号 + 1”。
- creator_trx_id：创建当前 read view 的事务版本号。



**在 RU 级别下，直接读取版本的最新记录就OK，对于 serializable 级别，则是通过添加互斥锁来访问数据，因此不需要 MVCC 的帮助。**



## next - key 锁

​	next - key 包含两个部分：

- **记录锁（行锁）**：记录锁是加载索引上的锁。
- **间隙锁**：间隙锁是加载索引之间的锁。



#### 原理

将当前数据行与上一条数据和吓一跳数据之间的间隙锁，保证此范围内读取的数据是一致的。







